<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Pickleball Catch!</title>
  <style>
    body { 
      margin: 0; 
      padding: 0;
      overflow: hidden; 
      background: black; 
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    canvas { 
      display: block; 
      background: black;
      max-width: 100vw;
      max-height: 100vh;
    }
    #muteButton {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 100;
      background: rgba(255,255,255,0.8);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
</head>
<body>
  <button id="muteButton">üîä</button>
  <canvas id="gameCanvas"></canvas>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const muteBtn = document.getElementById("muteButton");

    // 16:9Âõ∫ÂÆö„Çµ„Ç§„Ç∫Ë®≠ÂÆö
    const ASPECT_RATIO = 16 / 9;
    const BASE_WIDTH = 1600;
    const BASE_HEIGHT = 900;

    function resizeCanvas() {
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      
      let canvasWidth, canvasHeight;
      
      // „Çπ„Éû„ÉõÊ®™ÁîªÈù¢ÂØæÂøúÔºöÊ®™ÂπÖ„ÇíÂÑ™ÂÖà„Åó„Å¶Ë™øÊï¥
      if (windowWidth / windowHeight > ASPECT_RATIO) {
        // Ê®™„Åå‰Ωô„ÇãÂ†¥ÂêàÔºàÈÄöÂ∏∏„ÅÆPCÁ≠âÔºâ
        canvasHeight = windowHeight;
        canvasWidth = canvasHeight * ASPECT_RATIO;
      } else {
        // Á∏¶„Åå‰Ωô„ÇãÂ†¥ÂêàÔºà„Çπ„Éû„ÉõÊ®™ÁîªÈù¢Á≠âÔºâ- Ê®™ÂπÖ„ÅÑ„Å£„Å±„ÅÑ„ÇíÂÑ™ÂÖà
        canvasWidth = windowWidth;
        canvasHeight = canvasWidth / ASPECT_RATIO;
        
        // „ÇÇ„ÅóÈ´ò„Åï„ÅåÁîªÈù¢„ÇíË∂Ö„Åà„ÇãÂ†¥Âêà„ÅØÈ´ò„ÅïÂü∫Ê∫ñ„Å´Êàª„Åô
        if (canvasHeight > windowHeight) {
          canvasHeight = windowHeight;
          canvasWidth = canvasHeight * ASPECT_RATIO;
        }
      }
      
      canvas.width = BASE_WIDTH;
      canvas.height = BASE_HEIGHT;
      canvas.style.width = canvasWidth + 'px';
      canvas.style.height = canvasHeight + 'px';
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // „Çµ„Ç¶„É≥„ÉâÁÆ°ÁêÜ
    let isMuted = false;
    const bgm = new Audio("bgm.mp3"); 
    bgm.loop = true; 
    bgm.volume = 0.2;
    const catchNormalSound = new Audio("catch_normal.wav");
    const catchRareSound = new Audio("catch_rare.wav");
    const missSound = new Audio("miss.mp3");
    const gameoverSound = new Audio("gameover.mp3");

    muteBtn.addEventListener("click", () => {
      isMuted = !isMuted;
      muteBtn.textContent = isMuted ? "üîá" : "üîä";
      bgm.muted = isMuted;
      catchNormalSound.muted = isMuted;
      catchRareSound.muted = isMuted;
      missSound.muted = isMuted;
      gameoverSound.muted = isMuted;
    });

    // ÁîªÂÉèË™≠„ÅøËæº„Åø
    const bgImg = new Image(); bgImg.src = "bg.png";
    const titleImg = new Image(); titleImg.src = "title.png";
    const paddleImg = new Image(); paddleImg.src = "paddle.png";
    
    const ballImgs = {};
    const ballColors = ["pink", "orange", "lightblue", "blue", "green", "yellow", "rainbow"];
    ballColors.forEach(color => {
      const img = new Image();
      img.src = `${color}.png`;
      ballImgs[color] = img;
    });

    // „Ç≤„Éº„É†Áä∂ÊÖã
    let gameState = "title";
    let score = 0, highScore = 0, lives = 3;
    let paddle = { x: 0, y: 0, width: 225, height: 60 }; // „Éë„Éâ„É´„Çµ„Ç§„Ç∫1.5ÂÄçÔºà150x40 ‚Üí 225x60Ôºâ
    let balls = [];
    let effects = []; // „É¨„Ç§„É≥„Éú„Éº„Éú„Éº„É´Áî®„Ç®„Éï„Çß„ÇØ„Éà
    let lastSpawn = 0, maxBalls = 2, startTime = null;

    // „Éú„Éº„É´Ë®≠ÂÆöÔºà„Çµ„Ç§„Ç∫Ë™øÊï¥„ÄÅÈÄüÂ∫¶Ë™øÊï¥Ôºâ
    const BALL_SIZE = 180; // „Éú„Éº„É´„Çµ„Ç§„Ç∫„Çí180px„Å´
    const ballTypes = {
      pink: { speed: 2, score: 1 },      // „Å®„Å¶„ÇÇÈÅÖ„ÅÑ
      orange: { speed: 3, score: 1 },    // ÈÅÖ„ÅÑ
      lightblue: { speed: 4, score: 1 }, // ÊôÆÈÄö
      blue: { speed: 5, score: 1 },      // Â∞ë„ÅóÊó©„ÅÑ
      green: { speed: 6, score: 1 },     // Êó©„ÅÑ
      yellow: { speed: 7, score: 1 },    // „Å®„Å¶„ÇÇÊó©„ÅÑ
      rainbow: { speed: 25, score: 10, rare: true } // ÁâπÂà•„ÉªÊøÄÈÄüÔºàÈùí„ÅÆ5ÂÄçÔºâ
    };

    // ÂÖ•ÂäõÂá¶ÁêÜ
    function getCanvasCoordinate(clientX, clientY) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = BASE_WIDTH / rect.width;
      const scaleY = BASE_HEIGHT / rect.height;
      return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
      };
    }

    window.addEventListener("mousemove", e => {
      if (gameState !== "playing") return;
      const coord = getCanvasCoordinate(e.clientX, e.clientY);
      paddle.x = coord.x - paddle.width / 2;
      clampPaddle();
    });

    window.addEventListener("touchmove", e => {
      if (gameState !== "playing") return;
      e.preventDefault();
      const touch = e.touches[0];
      const coord = getCanvasCoordinate(touch.clientX, touch.clientY);
      paddle.x = coord.x - paddle.width / 2;
      clampPaddle();
    });

    function clampPaddle() {
      if (paddle.x < 0) paddle.x = 0;
      if (paddle.x + 300 > BASE_WIDTH) {  // „Éë„Éâ„É´„Çµ„Ç§„Ç∫300„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥
        paddle.x = BASE_WIDTH - 300;
      }
    }

    canvas.addEventListener("click", e => {
      const coord = getCanvasCoordinate(e.clientX, e.clientY);
      
      if (gameState === "title") {
        startGame();
      } else if (gameState === "gameover") {
        // Retry„Éú„Çø„É≥„ÅÆÂΩì„Åü„ÇäÂà§ÂÆö
        if (coord.x > BASE_WIDTH/2-150 && coord.x < BASE_WIDTH/2+150 &&
            coord.y > BASE_HEIGHT/2+120 && coord.y < BASE_HEIGHT/2+200) {
          startGame();
        }
      }
    });

    canvas.addEventListener("touchstart", e => {
      e.preventDefault();
      const touch = e.touches[0];
      const coord = getCanvasCoordinate(touch.clientX, touch.clientY);
      
      if (gameState === "title") {
        startGame();
      } else if (gameState === "gameover") {
        if (coord.x > BASE_WIDTH/2-150 && coord.x < BASE_WIDTH/2+150 &&
            coord.y > BASE_HEIGHT/2+120 && coord.y < BASE_HEIGHT/2+200) {
          startGame();
        }
      }
    });

    function startGame() {
      gameState = "playing";
      score = 0; 
      lives = 3;
      balls = [];
      effects = [];
      maxBalls = 2;
      startTime = Date.now();
      lastSpawn = 0;
      
      // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Çµ„Ç¶„É≥„Éâ„ÇíÂÅúÊ≠¢
      gameoverSound.pause();
      gameoverSound.currentTime = 0;
      
      bgm.currentTime = 0; 
      if (!isMuted) bgm.play();
    }

    // „Éú„Éº„É´Âá∫Áèæ„É´„Éº„É´
    function getAvailableColors(elapsed) {
      const colors = [];
      
      // Â∫èÁõ§Ôºà0„Äú15ÁßíÔºâ
      colors.push("orange", "lightblue", "blue");
      
      // 15Áßí„Äú30ÁßíÔºöÁ∑ëËøΩÂä†
      if (elapsed >= 15) colors.push("green");
      
      // 30Áßí„Äú45ÁßíÔºö„Éî„É≥„ÇØËøΩÂä†
      if (elapsed >= 30) colors.push("pink");
      
      // 45Áßí„Äú60ÁßíÔºöÈªÑËøΩÂä†
      if (elapsed >= 45) colors.push("yellow");
      
      return colors;
    }

    function spawnBall() {
      const elapsed = (Date.now() - startTime) / 1000;
      
      // „É¨„Ç§„É≥„Éú„Éº„ÅØÂ∏∏ÊôÇ‰ΩéÁ¢∫ÁéáÔºà3%Ôºâ
      if (Math.random() < 0.03) {
        const ball = { 
          x: Math.random() * (BASE_WIDTH - 180), 
          y: -180, 
          size: 180, 
          type: "rainbow" 
        };
        balls.push(ball);
        return;
      }
      
      // ÈÄöÂ∏∏„ÅÆ„Éú„Éº„É´
      const availableColors = getAvailableColors(elapsed);
      const color = availableColors[Math.floor(Math.random() * availableColors.length)];
      
      balls.push({ 
        x: Math.random() * (BASE_WIDTH - 180), 
        y: -180, 
        size: 180, 
        type: color 
      });
    }

    // „É¨„Ç§„É≥„Éú„Éº„Éú„Éº„É´Áî®„Ç®„Éï„Çß„ÇØ„Éà
    function addRainbowEffect(ball) {
      for (let i = 0; i < 3; i++) {
        effects.push({
          x: ball.x + ball.size/2 + (Math.random() - 0.5) * 40,
          y: ball.y + ball.size/2,
          size: Math.random() * 8 + 4,
          alpha: 1,
          color: `hsl(${Math.random() * 360}, 100%, 70%)`
        });
      }
    }

    function updateEffects() {
      effects.forEach((effect, i) => {
        effect.y += 2;
        effect.alpha -= 0.03;
        if (effect.alpha <= 0) {
          effects.splice(i, 1);
        }
      });
    }

    function drawEffects() {
      effects.forEach(effect => {
        ctx.save();
        ctx.globalAlpha = effect.alpha;
        ctx.fillStyle = effect.color;
        ctx.beginPath();
        ctx.arc(effect.x, effect.y, effect.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      });
    }

    function update() {
      if (!startTime) startTime = Date.now();
      const elapsed = (Date.now() - startTime) / 1000;

      // „Éú„Éº„É´Âá∫ÁèæÂà∂Âæ°
      if (elapsed - lastSpawn > 1 && balls.length < maxBalls) {
        spawnBall(); 
        lastSpawn = elapsed;
      }
      
      // Èõ£ÊòìÂ∫¶ÈÄ≤Ë°åÔºà15Áßí„Åî„Å®„Å´+1ÂÄã„ÄÅ150Áßí„ÅßÊúÄÂ§ß12ÂÄã„Åæ„ÅßÔºâ
      // 0Áßí:2ÂÄã ‚Üí 15Áßí:3ÂÄã ‚Üí 30Áßí:4ÂÄã ‚Üí 45Áßí:5ÂÄã ‚Üí 60Áßí:6ÂÄã ‚Üí 75Áßí:7ÂÄã ‚Üí 90Áßí:8ÂÄã ‚Üí 105Áßí:9ÂÄã ‚Üí 120Áßí:10ÂÄã ‚Üí 135Áßí:11ÂÄã ‚Üí 150Áßí:12ÂÄã
      const newMaxBalls = Math.min(12, 2 + Math.floor(elapsed / 15));
      if (newMaxBalls > maxBalls) {
        maxBalls = newMaxBalls;
      }

      paddle.y = BASE_HEIGHT - 120;
      balls.forEach((ball, i) => {
        ball.y += ballTypes[ball.type].speed;
        
        // „É¨„Ç§„É≥„Éú„Éº„Éú„Éº„É´„Å´„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
        if (ball.type === "rainbow") {
          addRainbowEffect(ball);
        }
        
        // ÂΩì„Åü„ÇäÂà§ÂÆöÔºà„Éë„Éâ„É´„Çµ„Ç§„Ç∫300„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥Ôºâ
        if (ball.y + ball.size >= paddle.y &&
            ball.x + ball.size > paddle.x && ball.x < paddle.x + 300) {
          score += ballTypes[ball.type].score;
          
          // „Çµ„Ç¶„É≥„ÉâÂÜçÁîü
          const sound = ball.type === "rainbow" ? catchRareSound : catchNormalSound;
          if (!isMuted) {
            const audioClone = sound.cloneNode();
            audioClone.play();
          }
          
          balls.splice(i, 1);
        } else if (ball.y > BASE_HEIGHT) {
          // „É©„Ç§„ÉïÊ∏õÂ∞ëÔºà„É¨„Ç§„É≥„Éú„Éº„ÅØÈô§„ÅèÔºâ
          if (!ballTypes[ball.type].rare) {
            lives--;
            if (!isMuted) {
              const missClone = missSound.cloneNode();
              missClone.play();
            }
            if (lives <= 0) gameOver();
          }
          balls.splice(i, 1);
        }
      });

      updateEffects();
    }

    function gameOver() {
      gameState = "gameover";
      bgm.pause(); 
      bgm.currentTime = 0;
      if (!isMuted) {
        gameoverSound.currentTime = 0; 
        gameoverSound.play();
      }
      if (score > highScore) highScore = score;
    }

    function draw() {
      // ËÉåÊôØ
      ctx.drawImage(bgImg, 0, 0, BASE_WIDTH, BASE_HEIGHT);
      
      // „Éë„Éâ„É´
      ctx.drawImage(paddleImg, paddle.x, paddle.y, 300, 80);
      
      // „Éú„Éº„É´
      balls.forEach(ball => {
        ctx.drawImage(ballImgs[ball.type], ball.x, ball.y, ball.size, ball.size);
      });
      
      // „Ç®„Éï„Çß„ÇØ„Éà
      drawEffects();
      
      // UI
      ctx.fillStyle = "white";
      ctx.font = "64px 'Fredoka One'";
      ctx.textAlign = "center";
      ctx.fillText("Score: " + score, BASE_WIDTH/2, 80);
      
      // „É©„Ç§„ÉïË°®Á§∫ÔºàËµ§Ëâ≤„ÄÅ2ÂÄç„Çµ„Ç§„Ç∫„ÄÅ‰ΩçÁΩÆ„Çí‰∏ã„Å´Ë™øÊï¥Ôºâ
      ctx.fillStyle = "red";
      ctx.font = "96px 'Fredoka One'";
      ctx.fillText("‚ô•".repeat(lives), BASE_WIDTH/2, 180);
    }

    function drawTitleScreen() {
      ctx.drawImage(titleImg, 0, 0, BASE_WIDTH, BASE_HEIGHT);
      
      ctx.fillStyle = "#ff66cc"; // „Éî„É≥„ÇØËâ≤
      ctx.font = "120px 'Fredoka One'";
      ctx.textAlign = "center";
      ctx.fillText("Pickleball Catch!", BASE_WIDTH/2, BASE_HEIGHT/2 - 60);
      
      // ÁÇπÊªÖÂäπÊûú
      if (Math.floor(Date.now() / 500) % 2 === 0) {
        ctx.fillStyle = "white";
        ctx.font = "64px 'Fredoka One'";
        ctx.fillText("Tap to Start!", BASE_WIDTH/2, BASE_HEIGHT/2 + 60);
      }
    }

    function drawGameOver() {
      ctx.fillStyle = "rgba(0,0,0,0.7)";
      ctx.fillRect(0, 0, BASE_WIDTH, BASE_HEIGHT);
      
      ctx.textAlign = "center";
      
      // GAME OVER
      ctx.fillStyle = "#ff66cc"; // „Éî„É≥„ÇØ
      ctx.font = "140px 'Fredoka One'";
      ctx.fillText("GAME OVER", BASE_WIDTH/2, BASE_HEIGHT/2 - 120);
      
      // „Çπ„Ç≥„Ç¢
      ctx.fillStyle = "#ff66cc"; // „Éî„É≥„ÇØ
      ctx.font = "80px 'Fredoka One'";
      ctx.fillText("Score: " + score, BASE_WIDTH/2, BASE_HEIGHT/2 - 20);
      
      // „Éè„Ç§„Çπ„Ç≥„Ç¢
      ctx.fillStyle = "#ffcc00"; // ÈªÑËâ≤
      ctx.fillText("High Score: " + highScore, BASE_WIDTH/2, BASE_HEIGHT/2 + 60);
      
      // Retry„Éú„Çø„É≥
      ctx.fillStyle = "#ff66cc";
      ctx.fillRect(BASE_WIDTH/2 - 150, BASE_HEIGHT/2 + 120, 300, 80);
      ctx.fillStyle = "white";
      ctx.font = "48px 'Fredoka One'";
      ctx.fillText("Retry", BASE_WIDTH/2, BASE_HEIGHT/2 + 175);
    }

    function loop() {
      ctx.clearRect(0, 0, BASE_WIDTH, BASE_HEIGHT);
      
      if (gameState === "title") {
        drawTitleScreen();
      } else if (gameState === "playing") {
        update();
        draw();
      } else if (gameState === "gameover") {
        drawGameOver();
      }
      
      requestAnimationFrame(loop);
    }

    loop();
  </script>
</body>
</html>