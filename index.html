<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Pickleball Catch Game</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: black;
    }
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      padding: 20px 40px;
      background: #ff66cc;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Fredoka One', cursive;
      z-index: 10;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
</head>
<body>
  <button id="startButton">START</button>
  <canvas id="gameCanvas"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // ---- 画面サイズを常に16:9に調整 ----
    function resizeCanvas() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      if (w / h > 16 / 9) {
        // 横長すぎる → 高さ基準
        canvas.height = h;
        canvas.width = h * (16 / 9);
      } else {
        // 縦長すぎる → 幅基準
        canvas.width = w;
        canvas.height = w * (9 / 16);
      }
      if (bgImg) {
        bgPattern = null; // 再生成のためリセット
      }
    }
    window.addEventListener("resize", resizeCanvas);

    // ---- 画像読み込み ----
    const bgImg = new Image();
    bgImg.src = "bg.png";
    const ballImages = {
      pink: "pink.png",
      orange: "orange.png",
      blue: "blue.png",
      lightblue: "lightblue.png",
      green: "green.png",
      yellow: "yellow.png",
      rainbow: "rainbow.png"
    };
    const loadedBalls = {};
    for (let key in ballImages) {
      const img = new Image();
      img.src = ballImages[key];
      loadedBalls[key] = img;
    }
    const paddleImg = new Image();
    paddleImg.src = "paddle.png";

    // ---- サウンド ----
    const bgm = new Audio("bgm.mp3");
    bgm.loop = true;
    bgm.volume = 0.2;

    const catchSound = new Audio("catch.mp3");
    const rareSound = new Audio("rare.mp3");

    // ---- ゲーム変数 ----
    let paddle, balls, score, lives, gameOver, gameStarted, startTime;
    let bgPattern = null;

    function initGame() {
      paddle = {
        x: canvas.width / 2,
        y: canvas.height - 80,
        width: 180, // 以前より拡大
        height: 60
      };
      balls = [];
      score = 0;
      lives = 3;
      gameOver = false;
      startTime = Date.now();
    }

    // ---- ボール生成 ----
    function spawnBall() {
      const types = ["pink", "orange", "blue", "lightblue", "green", "yellow", "rainbow"];
      let type = types[Math.floor(Math.random() * types.length)];
      let speed;
      switch (type) {
        case "pink": speed = 1.5; break;       // とてもゆっくり
        case "orange": speed = 2.5; break;    // ゆっくり
        case "blue": speed = 3.5; break;      // 遅め
        case "lightblue": speed = 4.5; break; // 普通
        case "green": speed = 5.5; break;     // 少し早い
        case "yellow": speed = 6.5; break;    // 早い
        case "rainbow": speed = 5.0; break;   // レア
      }
      // 全体底上げ（+2段階分相当）
      speed += 2;

      const size = 150; // 大きめボール
      balls.push({
        x: Math.random() * (canvas.width - size),
        y: -size,
        size: size,
        speed: speed,
        type: type
      });
    }

    // ---- ゲームループ ----
    function update() {
      if (gameOver) return;

      // 時間経過で出現数を増やす
      const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
      let maxBalls = Math.min(3 + Math.floor(elapsedSec / 5), 12);

      // ボール補充
      while (balls.length < maxBalls) {
        spawnBall();
      }

      // ボール更新
      balls.forEach(ball => {
        ball.y += ball.speed;
      });

      // 衝突判定
      balls = balls.filter(ball => {
        if (
          ball.x < paddle.x + paddle.width &&
          ball.x + ball.size > paddle.x &&
          ball.y + ball.size > paddle.y &&
          ball.y < paddle.y + paddle.height
        ) {
          // キャッチ
          score += (ball.type === "rainbow" ? 5 : 1);
          (ball.type === "rainbow" ? rareSound : catchSound).play();
          return false;
        } else if (ball.y > canvas.height) {
          lives--;
          if (lives <= 0) gameOver = true;
          return false;
        }
        return true;
      });
    }

    function draw() {
      // 背景
      ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

      // スコアとライフ
      ctx.fillStyle = "white";
      ctx.font = "48px 'Fredoka One'";
      ctx.textAlign = "center";
      ctx.fillText("SCORE: " + score, canvas.width / 2, 60);

      let hearts = "♥".repeat(lives);
      ctx.fillStyle = "pink";
      ctx.fillText(hearts, canvas.width / 2, 120);

      // パドル
      ctx.drawImage(paddleImg, paddle.x, paddle.y, paddle.width, paddle.height);

      // ボール
      balls.forEach(ball => {
        ctx.drawImage(loadedBalls[ball.type], ball.x, ball.y, ball.size, ball.size);
      });

      if (gameOver) {
        ctx.fillStyle = "yellow";
        ctx.font = "80px 'Fredoka One'";
        ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2);
        ctx.font = "48px 'Fredoka One'";
        ctx.fillText("FINAL SCORE: " + score, canvas.width / 2, canvas.height / 2 + 80);
      }
    }

    function loop() {
      if (gameStarted) {
        update();
        draw();
      }
      requestAnimationFrame(loop);
    }

    // ---- 入力 ----
    window.addEventListener("mousemove", e => {
      if (!gameStarted) return;
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      paddle.x = mouseX - paddle.width / 2;
    });
    window.addEventListener("touchmove", e => {
      if (!gameStarted) return;
      const rect = canvas.getBoundingClientRect();
      const touchX = e.touches[0].clientX - rect.left;
      paddle.x = touchX - paddle.width / 2;
    });

    // ---- スタート ----
    document.getElementById("startButton").addEventListener("click", () => {
      document.getElementById("startButton").style.display = "none";
      gameStarted = true;
      bgm.play();
      initGame();
    });

    resizeCanvas();
    loop();
  </script>
</body>
</html>
