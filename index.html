<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Pickleball Catch!</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  :root { color-scheme: light dark; }
  html, body {
    margin: 0; padding: 0; background: #000; overflow: hidden; height: 100%; width: 100%;
    touch-action: none; /* ã‚¹ãƒãƒ›ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«/ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ã‚’æŠ‘æ­¢ */
  }
  canvas { display: block; margin: 0 auto; background: #000; }
  #muteBtn {
    position: fixed; left: 12px; top: 12px; z-index: 20;
    background: rgba(255,255,255,0.8); border: 0; border-radius: 12px;
    padding: 6px 10px; font-size: 18px; cursor: pointer;
  }
</style>
</head>
<body>
<button id="muteBtn" aria-label="mute">ğŸ”Š</button>
<canvas id="game"></canvas>

<script>
/* =========================
   åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
========================= */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let state = 'TITLE'; // TITLE | PLAYING | GAMEOVER

// 16:9å›ºå®šã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç”»é¢ã„ã£ã±ã„ï¼‰
let scale = 1; // 1920x1080åŸºæº–ã®ã‚¹ã‚±ãƒ¼ãƒ«
function resizeCanvas() {
  let vw = window.innerWidth, vh = window.innerHeight;
  if (vw / vh > 16/9) {
    // æ¨ªã«ä½™ã‚‹ â†’ é«˜ã•åŸºæº–
    canvas.height = vh;
    canvas.width  = Math.floor(vh * 16/9);
  } else {
    // ç¸¦ã«ä½™ã‚‹ â†’ å¹…åŸºæº–
    canvas.width  = vw;
    canvas.height = Math.floor(vw * 9/16);
  }
  scale = canvas.width / 1920; // 1920x1080 ã‚’1.0ã¨ã™ã‚‹
}
window.addEventListener('resize', resizeCanvas, { passive:true });
resizeCanvas();

/* =========================
   ã‚¢ã‚»ãƒƒãƒˆ
========================= */
// ç”»åƒ
const imgBG = new Image(); imgBG.src = 'bg.png';
const imgTitle = new Image(); imgTitle.src = 'title.png';
const imgGameOver = new Image(); imgGameOver.src = 'gameover.png';
const imgPaddle = new Image(); imgPaddle.src = 'paddle.png';

const ballImgs = {
  pink:      new Image(),
  orange:    new Image(),
  lightblue: new Image(),
  blue:      new Image(),
  green:     new Image(),
  yellow:    new Image(),
  rainbow:   new Image()
};
ballImgs.pink.src      = 'pink.png';
ballImgs.orange.src    = 'orange.png';
ballImgs.lightblue.src = 'lightblue.png';
ballImgs.blue.src      = 'blue.png';
ballImgs.green.src     = 'green.png';
ballImgs.yellow.src    = 'yellow.png';
ballImgs.rainbow.src   = 'rainbow.png';

// éŸ³
const sNormal   = new Audio('catch_normal.wav');
const sRare     = new Audio('catch_rare.wav');
const sMiss     = new Audio('miss.mp3');
const sGameOver = new Audio('gameover.mp3');
[sNormal, sRare, sMiss].forEach(a => a.volume = 0.8);
sGameOver.volume = 0.5;

// ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆä¿å­˜ï¼‰
let muted = (localStorage.getItem('pickleball_muted') === 'true');
function applyMute(m) {
  muted = m;
  localStorage.setItem('pickleball_muted', m ? 'true' : 'false');
  document.getElementById('muteBtn').textContent = m ? 'ğŸ”‡' : 'ğŸ”Š';
  [sNormal, sRare, sMiss, sGameOver].forEach(a => a.muted = m);
}
applyMute(muted);
document.getElementById('muteBtn').addEventListener('click', () => applyMute(!muted));

/* =========================
   ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
========================= */
let score = 0;
let highScore = parseInt(localStorage.getItem('pickleball_highscore') || '0', 10);
let lives = 3;
let balls = [];
let lastTime = performance.now();
let startTime = performance.now();
let spawnCooldown = 0;        // æ¬¡ã®ç”Ÿæˆã¾ã§ã®æ™‚é–“(ç§’)
let spawnDelayMin = 0.35;     // é€£ç¶šã§åŒæ™‚æ¹§ãã‚’é˜²ããŸã‚ã®ä¸‹é™
let spawnDelayMax = 0.9;

const UI = {
  font(sizePx) { return `${Math.floor(sizePx*scale)}px 'Fredoka One', system-ui, sans-serif`; },
  centerText(text, y, color='#fff') {
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.fillText(text, canvas.width/2, y);
  }
};

// ãƒ‘ãƒ‰ãƒ«ï¼ˆç”»é¢å¹…ã«å¿œã˜ã¦è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
const paddle = {
  wBase: 320, hBase: 64,
  x: 0, y: 0,
  get w(){ return this.wBase * scale; },
  get h(){ return this.hBase * scale; },
  update() {
    this.y = canvas.height - this.h*1.4;
    // ç«¯ã‹ã‚‰ã¯ã¿å‡ºãªã„
    if (this.x < 0) this.x = 0;
    if (this.x + this.w > canvas.width) this.x = canvas.width - this.w;
  },
  draw() {
    ctx.drawImage(imgPaddle, this.x, this.y, this.w, this.h);
  }
};

// å…¥åŠ›ï¼ˆãƒã‚¦ã‚¹ / ã‚¿ãƒƒãƒï¼‰
function movePaddleTo(clientX) {
  const rect = canvas.getBoundingClientRect();
  const x = clientX - rect.left - paddle.w/2;
  paddle.x = Math.min(Math.max(x, 0), canvas.width - paddle.w);
}
canvas.addEventListener('mousemove', e => { if (state==='PLAYING') movePaddleTo(e.clientX); });
canvas.addEventListener('touchmove', e => {
  if (state==='PLAYING') { movePaddleTo(e.touches[0].clientX); }
},{passive:true});
canvas.addEventListener('click', () => {
  if (state==='TITLE' || state==='GAMEOVER') startGame();
});

/* =========================
   ãƒœãƒ¼ãƒ«
========================= */
class Ball {
  constructor(type, speedPxPerSec) {
    this.type = type;
    this.img = ballImgs[type];
    this.sizeBase = 96; // ç”»åƒã®è¦‹ã‚„ã™ã•é‡è¦–ã§å¤§ãã‚
    this.size = this.sizeBase * scale;
    const margin = 6 * scale;
    this.x = margin + Math.random() * (canvas.width - this.size - margin*2);
    this.y = -this.size;
    // é€Ÿåº¦ã¯ 1920x1080 åŸºæº–ã®px/secã‚’ã‚¹ã‚±ãƒ¼ãƒ«è£œæ­£
    this.vy = Math.max(80, speedPxPerSec) * (canvas.height/1080);
  }
  update(dt) {
    this.y += this.vy * dt;
  }
  draw() {
    ctx.drawImage(this.img, this.x, this.y, this.size, this.size);
  }
  isOut() { return this.y > canvas.height; }
  hitPaddle() {
    // AABBåˆ¤å®šï¼ˆå°‘ã—ç”˜ã‚ï¼‰
    return (this.y + this.size >= paddle.y) &&
           (this.x + this.size >= paddle.x + this.size*0.15) && // å·¦å´ã®ã™ã‚ŠæŠœã‘è»½æ¸›
           (this.x <= paddle.x + paddle.w - this.size*0.15);
  }
}

// å‡ºç¾ãƒ«ãƒ¼ãƒ«
function availableTypesAt(sec) {
  if (sec < 15) return ['orange','lightblue','blue'];
  if (sec < 30) return ['orange','lightblue','blue','green'];
  if (sec < 45) return ['orange','lightblue','blue','green','pink'];
  if (sec < 60) return ['orange','lightblue','blue','green','pink','yellow'];
  return ['orange','lightblue','blue','green','pink','yellow']; // 60ç§’ä»¥é™ï¼šå…¨è‰²
}
// ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆpx/secï¼‰åŸºæº–ï¼ˆblueã‚’æ¨™æº–ã¨ã—ã€rainbow=3å€ï¼‰
function speedFor(type) {
  switch(type){
    case 'pink':      return 120; // ã¨ã¦ã‚‚ã‚†ã£ãã‚Š
    case 'orange':    return 180; // ã‚†ã£ãã‚Š
    case 'lightblue': return 240; // é…ã‚
    case 'blue':      return 300; // æ™®é€š
    case 'green':     return 380; // å°‘ã—æ—©ã„
    case 'yellow':    return 480; // æ—©ã„
    case 'rainbow':   return 300*3; // æ¿€é€Ÿï¼ˆé’ã®3å€ï¼‰
  }
  return 300;
}

/* =========================
   ã‚²ãƒ¼ãƒ åˆ¶å¾¡
========================= */
function startGame(){
  state = 'PLAYING';
  score = 0; lives = 3; balls.length = 0;
  startTime = performance.now();
  spawnCooldown = 0;
  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³ã‚’ãƒªã‚»ãƒƒãƒˆ
  sGameOver.pause(); sGameOver.currentTime = 0;

  // åˆæœŸãƒ‘ãƒ‰ãƒ«ä½ç½®ï¼šä¸­å¤®
  paddle.x = (canvas.width - paddle.w)/2;
  paddle.update();
}

function gameOver(){
  state = 'GAMEOVER';
  if (score > highScore) {
    highScore = score;
    localStorage.setItem('pickleball_highscore', String(highScore));
  }
  if (!muted) { sGameOver.currentTime = 0; sGameOver.play().catch(()=>{}); }
}

// çµŒéæ™‚é–“(ç§’)ã¨æœ€å¤§åŒæ™‚æ•°
function elapsedSec() { return (performance.now() - startTime) / 1000; }
function maxConcurrentByTime(sec) { return Math.min(2 + Math.floor(sec / 10), 12); }

// 1ä½“ã‚¹ãƒãƒ¼ãƒ³ï¼ˆä½ç¢ºç‡ã§ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ï¼‰
function spawnOne(sec) {
  let types = availableTypesAt(sec).slice();
  if (Math.random() < 0.05) { // 5%ã§ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼
    types = ['rainbow'];
  }
  const t = types[Math.floor(Math.random()*types.length)];
  const spd = speedFor(t);
  balls.push(new Ball(t, spd));
}

/* =========================
   ãƒ«ãƒ¼ãƒ—
========================= */
function update(dt){
  if (state !== 'PLAYING') return;

  const sec = elapsedSec();
  const maxN = maxConcurrentByTime(sec);

  // ã‚¹ãƒãƒ¼ãƒ³é–“éš”åˆ¶å¾¡ï¼ˆåŒæ™‚æ¹§ãé˜²æ­¢ï¼‰
  spawnCooldown -= dt;
  if (balls.length < maxN && spawnCooldown <= 0) {
    spawnOne(sec);
    spawnCooldown = randRange(spawnDelayMin, spawnDelayMax); // æ¬¡ã®æ¹§ãã¾ã§ã®é–“éš”
  }

  // æ›´æ–°
  for (let i = balls.length-1; i >= 0; i--) {
    const b = balls[i];
    b.update(dt);

    if (b.hitPaddle()) {
      // ã‚¹ã‚³ã‚¢ & éŸ³
      if (b.type === 'rainbow') {
        score += 10;
        if (!muted) { sRare.currentTime = 0; sRare.play().catch(()=>{}); }
      } else {
        score += 1;
        if (!muted) { sNormal.currentTime = 0; sNormal.play().catch(()=>{}); }
      }
      balls.splice(i,1);
      continue;
    }

    if (b.isOut()) {
      if (b.type !== 'rainbow') {
        lives -= 1;
        if (!muted) { sMiss.currentTime = 0; sMiss.play().catch(()=>{}); }
        if (lives <= 0) {
          gameOver();
          return;
        }
      }
      balls.splice(i,1);
    }
  }

  paddle.update();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (state === 'TITLE') {
    // ã‚¿ã‚¤ãƒˆãƒ«èƒŒæ™¯
    if (imgTitle.complete && imgTitle.naturalWidth > 0) {
      ctx.drawImage(imgTitle, 0,0, canvas.width, canvas.height);
    } else {
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    // ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—
    ctx.font = UI.font(96);
    ctx.fillStyle = '#ffffff';
    UI.centerText('Pickleball Catch!', canvas.height*0.42);
    // Tap to Startï¼ˆç‚¹æ»…ï¼‰
    if (Math.floor(Date.now()/500)%2===0) {
      ctx.font = UI.font(56);
      UI.centerText('Tap to Start!', canvas.height*0.60, '#fff');
    }
    return;
  }

  // ã‚²ãƒ¼ãƒ ãƒ»ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å…±é€šï¼šèƒŒæ™¯
  if (state === 'GAMEOVER') {
    if (imgGameOver.complete && imgGameOver.naturalWidth > 0) {
      ctx.drawImage(imgGameOver, 0,0, canvas.width, canvas.height);
    } else if (imgBG.complete && imgBG.naturalWidth > 0) {
      ctx.drawImage(imgBG, 0,0, canvas.width, canvas.height);
    } else {
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    }
  } else {
    if (imgBG.complete && imgBG.naturalWidth > 0) {
      ctx.drawImage(imgBG, 0,0, canvas.width, canvas.height);
    } else {
      ctx.fillStyle = '#87CEEB'; ctx.fillRect(0,0,canvas.width,canvas.height);
    }
  }

  if (state === 'PLAYING') {
    // ãƒœãƒ¼ãƒ«
    for (const b of balls) b.draw();
    // ãƒ‘ãƒ‰ãƒ«
    paddle.draw();

    // UIï¼ˆä¸Šéƒ¨ä¸­å¤®ï¼‰
    ctx.textAlign = 'center';
    ctx.fillStyle = '#fff';
    ctx.font = UI.font(52);
    UI.centerText(`SCORE: ${score}`, canvas.height*0.07);
    ctx.fillStyle = 'pink';
    UI.centerText('â™¥'.repeat(lives), canvas.height*0.13);
  }

  if (state === 'GAMEOVER') {
    ctx.textAlign = 'center';
    ctx.fillStyle = '#fff';
    ctx.font = UI.font(72);
    UI.centerText('GAME OVER', canvas.height*0.45);
    ctx.font = UI.font(56);
    UI.centerText(`Your Score: ${score}`, canvas.height*0.56);
    UI.centerText(`High Score: ${highScore}`, canvas.height*0.63);
    if (Math.floor(Date.now()/500)%2===0) {
      ctx.font = UI.font(48);
      UI.centerText('Tap to Retry', canvas.height*0.80);
    }
  }
}

function loop(now){
  const dt = Math.min(0.033, (now - lastTime) / 1000); // æœ€å¤§~33ms
  lastTime = now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* =========================
   ãƒ˜ãƒ«ãƒ‘
========================= */
function randRange(min, max){ return min + Math.random()*(max-min); }
</script>
</body>
</html>
