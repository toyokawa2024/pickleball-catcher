<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
/>
<title>Pickleball Catch!</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  html, body {
    margin: 0; padding: 0;
    background: #000;            /* ãƒ¬ã‚¿ãƒ¼ãƒœãƒƒã‚¯ã‚¹ã¯é»’ */
    overflow: hidden;
    height: 100%; width: 100%;
    touch-action: none;          /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«/ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ã‚’æŠ‘æ­¢ */
  }
  canvas { display: block; margin: 0 auto; background: #000; }

  /* ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ */
  #muteBtn {
    position: fixed;
    left: 12px; top: 12px;
    z-index: 20;
    background: rgba(255,255,255,0.85);
    border: 0; border-radius: 12px;
    padding: 6px 10px;
    font-size: 18px;
    cursor: pointer;
  }
</style>
</head>
<body>
<button id="muteBtn" aria-label="mute">ğŸ”Š</button>
<canvas id="game"></canvas>

<script>
/* =========================
   ç”»é¢ï¼ˆ16:9å›ºå®š & ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
========================= */
const CANVAS_BASE_W = 1920;
const CANVAS_BASE_H = 1080;

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let scale = 1; // 1920x1080 ã‚’ 1.0 ã¨ã™ã‚‹

function resizeCanvas() {
  let vw = window.innerWidth, vh = window.innerHeight;
  const aspect = 16/9;
  if (vw / vh > aspect) {
    // æ¨ªãŒä½™ã‚‹ â†’ é«˜ã•åŸºæº–
    canvas.height = vh;
    canvas.width  = Math.floor(vh * aspect);
  } else {
    // ç¸¦ãŒä½™ã‚‹ â†’ å¹…åŸºæº–
    canvas.width  = vw;
    canvas.height = Math.floor(vw / aspect);
  }
  scale = canvas.width / CANVAS_BASE_W;
}
window.addEventListener('resize', resizeCanvas, { passive:true });
resizeCanvas();

/* =========================
   ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
========================= */
const imgTitle    = new Image(); imgTitle.src    = 'title.png';
const imgBG       = new Image(); imgBG.src       = 'bg.png';
const imgGameOver = new Image(); imgGameOver.src = 'gameover.png';
const imgPaddle   = new Image(); imgPaddle.src   = 'paddle.png';

const ballImgs = {
  pink:      new Image(),
  orange:    new Image(),
  lightblue: new Image(),
  blue:      new Image(),
  green:     new Image(),
  yellow:    new Image(),
  rainbow:   new Image()
};
ballImgs.pink.src      = 'pink.png';
ballImgs.orange.src    = 'orange.png';
ballImgs.lightblue.src = 'lightblue.png';
ballImgs.blue.src      = 'blue.png';
ballImgs.green.src     = 'green.png';
ballImgs.yellow.src    = 'yellow.png';
ballImgs.rainbow.src   = 'rainbow.png';

/* =========================
   ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆä¿å­˜ï¼‰
========================= */
const sCatchNormal = new Audio('catch_normal.wav');
const sCatchRare   = new Audio('catch_rare.wav');
const sMiss        = new Audio('miss.mp3');
const sGameOver    = new Audio('gameover.mp3');
const sBGM         = new Audio('bgm.mp3');
sBGM.loop = true;
sGameOver.volume = 0.5;

let muted = (localStorage.getItem('pickle_muted') === 'true');
function applyMute(m) {
  muted = m;
  [sCatchNormal, sCatchRare, sMiss, sGameOver, sBGM].forEach(a => a.muted = m);
  document.getElementById('muteBtn').textContent = m ? 'ğŸ”‡' : 'ğŸ”Š';
  localStorage.setItem('pickle_muted', m ? 'true' : 'false');
}
applyMute(muted);
document.getElementById('muteBtn').addEventListener('click', () => {
  applyMute(!muted);
  if (!muted && state === 'PLAYING') { sBGM.play().catch(()=>{}); }
  if (muted) sBGM.pause();
});

/* =========================
   çŠ¶æ…‹ã¨UI
========================= */
let state = 'TITLE'; // TITLE | PLAYING | GAMEOVER
let score = 0;
let highScore = parseInt(localStorage.getItem('pickle_highscore') || '0', 10);
let lives = 3;
let balls = [];
let lastTime = performance.now();
let startTime = performance.now();

const UI = {
  font(px) { return `${Math.floor(px*scale)}px 'Fredoka One', system-ui, sans-serif`; },
  center(text, y, color='#fff') {
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.fillText(text, canvas.width/2, y);
  }
};

/* =========================
   ãƒ‘ãƒ‰ãƒ«ï¼ˆPCè¦‹ãŸç›®ç¶­æŒï¼šä»®æƒ³å€¤åŸºæº–ï¼‰
========================= */
const paddle = {
  // PCã§ã€Œã¡ã‚‡ã†ã©è‰¯ã‹ã£ãŸã€æƒ³å®šã®ä»®æƒ³ã‚µã‚¤ã‚ºï¼ˆå¿…è¦ãªã‚‰ã“ã“ã ã‘å¾®èª¿æ•´ï¼‰
  wBase: 450,   // 1920åŸºæº–ã®å¹…
  hBase: 90,    // 1920åŸºæº–ã®é«˜ã•
  x: 0, y: 0,
  get w(){ return this.wBase * scale; },
  get h(){ return this.hBase * scale; },
  update() {
    // ç”»é¢ä¸‹ã‹ã‚‰å°‘ã—ä¸Š
    this.y = canvas.height - this.h*1.5;
    // ã¯ã¿å‡ºã—é˜²æ­¢
    if (this.x < 0) this.x = 0;
    if (this.x + this.w > canvas.width) this.x = canvas.width - this.w;
  },
  draw() {
    ctx.drawImage(imgPaddle, this.x, this.y, this.w, this.h);
  }
};

// å…¥åŠ›ï¼ˆãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒï¼‰
function movePaddleTo(clientX) {
  const rect = canvas.getBoundingClientRect();
  const x = clientX - rect.left - paddle.w/2;
  paddle.x = Math.min(Math.max(x, 0), canvas.width - paddle.w);
}
canvas.addEventListener('mousemove', e => { if (state==='PLAYING') movePaddleTo(e.clientX); });
canvas.addEventListener('touchmove', e => {
  if (state==='PLAYING') movePaddleTo(e.touches[0].clientX);
},{passive:true});
canvas.addEventListener('click', () => {
  if (state==='TITLE' || state==='GAMEOVER') startGame();
});

/* =========================
   ãƒœãƒ¼ãƒ«ï¼ˆPCè¦‹ãŸç›®ç¶­æŒï¼šä»®æƒ³å€¤åŸºæº–ï¼‰
========================= */
const BALL_SIZE_BASE = 120; // 1920åŸºæº–ã®ã‚µã‚¤ã‚ºï¼ˆPCã§è‰¯ã‹ã£ãŸã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ï¼‰

function speedFor(type) {
  // px/ç§’ï¼ˆä»®æƒ³1080åŸºæº–ï¼‰ã€‚rainbowã¯blueã®3å€
  switch(type){
    case 'pink':      return 140; // ã¨ã¦ã‚‚ã‚†ã£ãã‚Š
    case 'orange':    return 190; // ã‚†ã£ãã‚Š
    case 'lightblue': return 240; // é…ã‚
    case 'blue':      return 300; // æ™®é€š
    case 'green':     return 380; // å°‘ã—æ—©ã„
    case 'yellow':    return 480; // æ—©ã„
    case 'rainbow':   return 900; // æ¿€é€Ÿï¼ˆblueã®ç´„3å€ï¼‰
  }
  return 300;
}

class Ball {
  constructor(type) {
    this.type = type;
    this.img = ballImgs[type];
    this.size = BALL_SIZE_BASE * scale;

    // ç«¯ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«å·¦å³ãƒãƒ¼ã‚¸ãƒ³
    const margin = 6 * scale;
    this.x = margin + Math.random() * (canvas.width - this.size - margin*2);
    this.y = -this.size;

    // é€Ÿåº¦ã¯ä»®æƒ³1080ã«å¯¾ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«è£œæ­£
    this.vy = speedFor(type) * (canvas.height / CANVAS_BASE_H);
  }
  update(dt) { this.y += this.vy * dt; }
  draw() { ctx.drawImage(this.img, this.x, this.y, this.size, this.size); }
  isOut() { return this.y > canvas.height; }
  hitPaddle() {
    // AABBï¼ˆè‹¥å¹²ç”˜ã‚ã«ã—ã¦è²«é€šã‚’é˜²æ­¢ï¼‰
    const px = paddle.x, py = paddle.y, pw = paddle.w, ph = paddle.h;
    return (
      this.y + this.size >= py &&
      this.y <= py + ph &&
      this.x + this.size >= px + this.size*0.12 &&   // å·¦ç«¯ã™ã‚ŠæŠœã‘è»½æ¸›
      this.x <= px + pw - this.size*0.12
    );
  }
}

/* =========================
   å‡ºç¾ãƒ«ãƒ¼ãƒ« & é›£æ˜“åº¦
========================= */
function availableTypesAt(sec) {
  if (sec < 15) return ['orange','lightblue','blue'];
  if (sec < 30) return ['orange','lightblue','blue','green'];
  if (sec < 45) return ['orange','lightblue','blue','green','pink'];
  if (sec < 60) return ['orange','lightblue','blue','green','pink','yellow'];
  return ['orange','lightblue','blue','green','pink','yellow']; // 60ç§’ä»¥é™ï¼šå…¨è‰²
}
function maxConcurrentByTime(sec) { return Math.min(2 + Math.floor(sec / 10), 12); }

// åŒæ™‚æ¹§ãé˜²æ­¢ã®ãŸã‚ã€ã‚¹ãƒãƒ¼ãƒ³é–“éš”ã«ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ã‚£ãƒ¬ã‚¤
let spawnCooldown = 0;
const SPAWN_DELAY_MIN = 0.35;
const SPAWN_DELAY_MAX = 0.9;

function spawnOne(sec) {
  // ä½ç¢ºç‡ã§å¸¸æ™‚ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼
  if (Math.random() < 0.05) {
    balls.push(new Ball('rainbow'));
    return;
  }
  const types = availableTypesAt(sec);
  const t = types[Math.floor(Math.random()*types.length)];
  balls.push(new Ball(t));
}

/* =========================
   ã‚²ãƒ¼ãƒ åˆ¶å¾¡
========================= */
function startGame(){
  state = 'PLAYING';
  score = 0; lives = 3; balls.length = 0;
  startTime = performance.now();
  spawnCooldown = 0;

  // ãƒ‘ãƒ‰ãƒ«åˆæœŸä½ç½®ï¼ˆä¸­å¤®ï¼‰
  paddle.x = (canvas.width - paddle.w) / 2;
  paddle.update();

  // BGMç®¡ç†
  sGameOver.pause(); sGameOver.currentTime = 0;
  if (!muted) { sBGM.currentTime = 0; sBGM.play().catch(()=>{}); }
}

function gameOver(){
  state = 'GAMEOVER';
  if (score > highScore) {
    highScore = score;
    localStorage.setItem('pickle_highscore', String(highScore));
  }
  sBGM.pause();
  if (!muted) { sGameOver.currentTime = 0; sGameOver.play().catch(()=>{}); }
}

function elapsedSec(){ return (performance.now() - startTime) / 1000; }

/* =========================
   ãƒ«ãƒ¼ãƒ—
========================= */
let lastTs = performance.now();
function loop(ts){
  const dt = Math.min(0.033, (ts - lastTs) / 1000);
  lastTs = ts;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function update(dt){
  if (state !== 'PLAYING') return;

  // ã‚¹ãƒãƒ¼ãƒ³
  const sec = elapsedSec();
  const maxN = maxConcurrentByTime(sec);
  spawnCooldown -= dt;
  if (balls.length < maxN && spawnCooldown <= 0) {
    spawnOne(sec);
    spawnCooldown = rand(SPAWN_DELAY_MIN, SPAWN_DELAY_MAX);
  }

  // ãƒœãƒ¼ãƒ«æ›´æ–° & åˆ¤å®š
  for (let i = balls.length-1; i >= 0; i--) {
    const b = balls[i];
    b.update(dt);

    if (b.hitPaddle()) {
      // ã‚¹ã‚³ã‚¢ & åŠ¹æœéŸ³
      if (b.type === 'rainbow') { score += 10; if (!muted){ sCatchRare.currentTime=0; sCatchRare.play().catch(()=>{});} }
      else { score += 1; if (!muted){ sCatchNormal.currentTime=0; sCatchNormal.play().catch(()=>{});} }
      balls.splice(i,1);
      continue;
    }

    if (b.isOut()) {
      if (b.type !== 'rainbow') {
        lives -= 1;
        if (!muted){ sMiss.currentTime=0; sMiss.play().catch(()=>{}); }
        if (lives <= 0) { gameOver(); return; }
      }
      balls.splice(i,1);
    }
  }

  paddle.update();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (state === 'TITLE') {
    // ã‚¿ã‚¤ãƒˆãƒ«èƒŒæ™¯
    if (imgTitle.complete && imgTitle.naturalWidth>0) {
      ctx.drawImage(imgTitle, 0,0, canvas.width, canvas.height);
    } else {
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    // ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰ï¼† Tap to Startï¼ˆç™½ãƒ»ç‚¹æ»…ï¼‰
    ctx.textAlign = 'center';
    ctx.font = UI.font(96);
    UI.center('Pickleball Catch!', canvas.height*0.42, '#ff77b9'); // ãƒ”ãƒ³ã‚¯
    if (Math.floor(Date.now()/500)%2===0) {
      ctx.font = UI.font(56);
      UI.center('Tap to Start!', canvas.height*0.60, '#ffffff');
    }
    return;
  }

  // èƒŒæ™¯ï¼ˆãƒ—ãƒ¬ã‚¤/ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰
  if (state === 'GAMEOVER') {
    if (imgGameOver.complete && imgGameOver.naturalWidth>0) {
      ctx.drawImage(imgGameOver, 0,0, canvas.width, canvas.height);
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§é€šå¸¸èƒŒæ™¯
      if (imgBG.complete && imgBG.naturalWidth>0) ctx.drawImage(imgBG, 0,0, canvas.width, canvas.height);
      else { ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height); }
    }
  } else {
    if (imgBG.complete && imgBG.naturalWidth>0) ctx.drawImage(imgBG, 0,0, canvas.width, canvas.height);
    else { ctx.fillStyle='#87CEEB'; ctx.fillRect(0,0,canvas.width,canvas.height); }
  }

  if (state === 'PLAYING') {
    // ãƒœãƒ¼ãƒ«
    for (const b of balls) b.draw();
    // ãƒ‘ãƒ‰ãƒ«
    paddle.draw();

    // UIï¼ˆä¸Šéƒ¨ä¸­å¤®ãƒ»å¤§ãã‚ï¼‰
    ctx.textAlign = 'center';
    ctx.font = UI.font(52);
    ctx.fillStyle = '#ffffff';
    UI.center(`SCORE: ${score}`, canvas.height*0.075, '#fff');
    UI.center('â™¥'.repeat(lives), canvas.height*0.135, '#ff7eb6'); // ãƒ”ãƒ³ã‚¯ãƒãƒ¼ãƒˆ
  }

  if (state === 'GAMEOVER') {
    ctx.textAlign = 'center';
    ctx.font = UI.font(72);
    UI.center('GAME OVER', canvas.height*0.47, '#ffffff');
    ctx.font = UI.font(56);
    UI.center(`Your Score: ${score}`, canvas.height*0.58, '#ffffff');
    UI.center(`High Score: ${highScore}`, canvas.height*0.66, '#ffffff');
    if (Math.floor(Date.now()/500)%2===0) {
      ctx.font = UI.font(48);
      UI.center('Tap to Retry', canvas.height*0.82, '#ffffff');
    }
  }
}

/* =========================
   ãƒ˜ãƒ«ãƒ‘
========================= */
function rand(min,max){ return min + Math.random()*(max-min); }

</script>
</body>
</html>
