<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Catch Game</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      background: black;
    }
    #muteButton {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      font-size: 20px;
      background: rgba(255,255,255,0.7);
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
    }
  </style>
</head>
<body>
  <button id="muteButton">🔊</button>
  <canvas id="gameCanvas"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // --- サイズ調整（横固定 16:9） ---
    function resizeCanvas() {
      let w = window.innerWidth;
      let h = window.innerHeight;
      let aspect = 16 / 9;
      if (w / h > aspect) {
        w = h * aspect;
      } else {
        h = w / aspect;
      }
      canvas.width = w;
      canvas.height = h;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // --- 画像 ---
    const bgImage = new Image();
    bgImage.src = "bg.png";
    const paddleImage = new Image();
    paddleImage.src = "paddle.png";

    const ballImages = {
      pink: loadImg("pink.png"),
      orange: loadImg("orange.png"),
      blue: loadImg("blue.png"),
      lightblue: loadImg("lightblue.png"),
      green: loadImg("green.png"),
      yellow: loadImg("yellow.png"),
      rainbow: loadImg("rainbow.png"),
    };

    function loadImg(src) {
      const img = new Image();
      img.src = src;
      return img;
    }

    // --- 音声 ---
    const bgm = new Audio("bgm.mp3");
    bgm.loop = true;
    bgm.volume = 0.2;

    const catchNormal = new Audio("catch_normal.wav");
    const catchRare = new Audio("catch_rare.wav");
    const missSound = new Audio("miss.mp3");
    const gameoverSound = new Audio("gameover.mp3");
    gameoverSound.volume = 0.5;

    let muted = localStorage.getItem("muted") === "true";
    updateMute();

    document.getElementById("muteButton").addEventListener("click", () => {
      muted = !muted;
      localStorage.setItem("muted", muted);
      updateMute();
    });

    function updateMute() {
      const btn = document.getElementById("muteButton");
      if (muted) {
        bgm.pause();
        btn.textContent = "🔇";
      } else {
        if (gameState === "playing") bgm.play();
        btn.textContent = "🔊";
      }
    }

    // --- ゲーム変数 ---
    let gameState = "title";
    let score = 0;
    let highScore = 0;
    let lives = 3;
    let balls = [];
    let paddleX = 0;
    const PADDLE_WIDTH = 120;
    const PADDLE_HEIGHT = 40;

    const BALL_SIZE = 48; // ← 1.5倍サイズ
    const BALL_SPEEDS = {
      pink: 2,
      orange: 3,
      blue: 4,
      lightblue: 5,
      green: 6,
      yellow: 7,
      rainbow: 9,
    };

    let lastBallIncrease = Date.now();
    let maxBalls = 2;

    // --- イベント ---
    canvas.addEventListener("mousemove", e => {
      let rect = canvas.getBoundingClientRect();
      let x = e.clientX - rect.left;
      paddleX = Math.min(Math.max(x - PADDLE_WIDTH / 2, 0), canvas.width - PADDLE_WIDTH);
    });

    canvas.addEventListener("touchmove", e => {
      let rect = canvas.getBoundingClientRect();
      let x = e.touches[0].clientX - rect.left;
      paddleX = Math.min(Math.max(x - PADDLE_WIDTH / 2, 0), canvas.width - PADDLE_WIDTH);
    });

    canvas.addEventListener("click", () => {
      if (gameState === "title") startGame();
      else if (gameState === "gameover") startGame();
    });

    // --- ゲーム開始 ---
    function startGame() {
      score = 0;
      lives = 3;
      balls = [];
      maxBalls = 2;
      lastBallIncrease = Date.now();
      gameState = "playing";
      if (!muted) {
        bgm.currentTime = 0;
        bgm.play();
      }
    }

    // --- ボール生成 ---
    function spawnBall() {
      const colors = Object.keys(ballImages);
      let color = colors[Math.floor(Math.random() * colors.length)];
      // 出現制御（最初は遅い色多め）
      if (score < 50) {
        color = ["pink","orange","blue","lightblue"][Math.floor(Math.random()*4)];
      }
      const x = Math.random() * (canvas.width - BALL_SIZE);
      balls.push({x, y: -BALL_SIZE, color});
    }

    // --- 更新 ---
    function update() {
      if (gameState === "playing") {
        // ボール増加（10秒ごと+1）
        if (Date.now() - lastBallIncrease > 10000) {
          maxBalls = Math.min(12, maxBalls + 1);
          lastBallIncrease = Date.now();
        }

        // ボール追加
        if (balls.length < maxBalls) spawnBall();

        // ボール移動
        balls.forEach(ball => {
          ball.y += BALL_SPEEDS[ball.color];
        });

        // 衝突判定
        balls = balls.filter(ball => {
          if (ball.y + BALL_SIZE >= canvas.height - PADDLE_HEIGHT) {
            if (ball.x + BALL_SIZE > paddleX && ball.x < paddleX + PADDLE_WIDTH) {
              if (ball.color === "rainbow") {
                score += 10;
                if (!muted) { catchRare.currentTime = 0; catchRare.play(); }
              } else {
                score += 1;
                if (!muted) { catchNormal.currentTime = 0; catchNormal.play(); }
              }
              return false;
            } else {
              if (ball.color !== "rainbow") {
                lives--;
                if (!muted) { missSound.currentTime = 0; missSound.play(); }
                if (lives <= 0) {
                  gameState = "gameover";
                  highScore = Math.max(highScore, score);
                  if (!muted) {
                    bgm.pause();
                    gameoverSound.currentTime = 0;
                    gameoverSound.play();
                  }
                }
              }
              return false;
            }
          }
          return true;
        });
      }
    }

    // --- 描画 ---
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (gameState === "title") {
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.font = `${Math.floor(canvas.height / 12)}px 'Fredoka One'`;
        ctx.textAlign = "center";

        // Tap to Start 点滅
        if (Math.floor(Date.now() / 500) % 2 === 0) {
          ctx.fillText("Tap to Start", canvas.width / 2, canvas.height * 0.7);
        }

      } else if (gameState === "playing") {
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

        // ボール描画
        balls.forEach(ball => {
          ctx.drawImage(ballImages[ball.color], ball.x, ball.y, BALL_SIZE, BALL_SIZE);
        });

        // パドル描画
        ctx.drawImage(paddleImage, paddleX, canvas.height - PADDLE_HEIGHT, PADDLE_WIDTH, PADDLE_HEIGHT);

        // スコア＆ライフ
        ctx.fillStyle = "white";
        ctx.font = `${Math.floor(canvas.height / 15)}px 'Fredoka One'`;
        ctx.textAlign = "center";
        ctx.fillText(`Score: ${score}`, canvas.width / 2, 60);

        ctx.fillStyle = "pink";
        ctx.font = `${Math.floor(canvas.height / 12)}px 'Fredoka One'`;
        ctx.fillText("💛".repeat(lives), canvas.width / 2, 120);

      } else if (gameState === "gameover") {
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "red";
        ctx.font = `${Math.floor(canvas.height / 10)}px 'Fredoka One'`;
        ctx.textAlign = "center";
        ctx.fillText("GAME OVER", canvas.width / 2, canvas.height * 0.4);

        ctx.fillStyle = "white";
        ctx.font = `${Math.floor(canvas.height / 15)}px 'Fredoka One'`;
        ctx.fillText(`Score: ${score}`, canvas.width / 2, canvas.height * 0.55);
        ctx.fillText(`High Score: ${highScore}`, canvas.width / 2, canvas.height * 0.65);

        ctx.fillText("Tap to Retry", canvas.width / 2, canvas.height * 0.8);
      }
    }

    // --- メインループ ---
    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }
    loop();

    // --- 画面回転制御（横固定） ---
    screen.orientation.lock("landscape").catch(()=>{});
  </script>
</body>
</html>
