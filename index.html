<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Catch Game</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: black;
  }
  canvas {
    display: block;
  }
  #muteBtn {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
    background: rgba(255,255,255,0.7);
    border: none;
    border-radius: 10px;
    padding: 5px 10px;
    font-size: 18px;
    cursor: pointer;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<button id="muteBtn">🔊</button>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  let w = window.innerWidth;
  let h = window.innerHeight;
  if (w/h > 16/9) {
    h = h;
    w = h * 16/9;
  } else {
    w = w;
    h = w * 9/16;
  }
  canvas.width = w;
  canvas.height = h;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// 画像
const bgImage = new Image();
bgImage.src = "bg.png";
const paddleImage = new Image();
paddleImage.src = "paddle.png";
const titleImage = new Image();
titleImage.src = "title.png";

const ballImages = {
  pink: "pink.png",
  orange: "orange.png",
  blue: "blue.png",
  green: "green.png",
  yellow: "yellow.png",
  lightblue: "lightblue.png",
  rainbow: "rainbow.png"
};
for (let key in ballImages) {
  const img = new Image();
  img.src = ballImages[key];
  ballImages[key] = img;
}

// 音声
let bgm = new Audio("bgm.mp3");
bgm.loop = true;
bgm.volume = 0.2;

let catchNormal = new Audio("catch_normal.wav");
let catchRare = new Audio("catch_rare.wav");
let missSound = new Audio("miss.mp3");
let gameoverSound = new Audio("gameover.mp3");
gameoverSound.volume = 0.5;

let isMuted = localStorage.getItem("muted") === "true";
function setMute(mute) {
  isMuted = mute;
  localStorage.setItem("muted", mute);
  document.getElementById("muteBtn").textContent = mute ? "🔇" : "🔊";
  [bgm, catchNormal, catchRare, missSound, gameoverSound].forEach(s => {
    s.muted = mute;
  });
}
setMute(isMuted);
document.getElementById("muteBtn").addEventListener("click", () => {
  setMute(!isMuted);
});

// ゲーム変数
let gameState = "title";
let paddle = { x: canvas.width/2, y: canvas.height*0.9, w: 100, h: 30 };
let balls = [];
let score = 0;
let lives = 3;
let highScore = 0;
let lastSpawnTime = 0;
let spawnInterval = 2000;
let startTime = 0;
let maxBalls = 2;

const speeds = {
  pink: 1, orange: 2, blue: 3, green: 4, yellow: 5, lightblue: 6, rainbow: 6
};

canvas.addEventListener("mousemove", e => {
  let rect = canvas.getBoundingClientRect();
  let x = e.clientX - rect.left;
  paddle.x = Math.min(Math.max(x, paddle.w/2), canvas.width - paddle.w/2);
});
canvas.addEventListener("touchmove", e => {
  let rect = canvas.getBoundingClientRect();
  let x = e.touches[0].clientX - rect.left;
  paddle.x = Math.min(Math.max(x, paddle.w/2), canvas.width - paddle.w/2);
});
canvas.addEventListener("click", () => {
  if (gameState === "title") {
    startGame();
  } else if (gameState === "gameover") {
    startGame();
  }
});

function startGame() {
  gameState = "playing";
  balls = [];
  score = 0;
  lives = 3;
  maxBalls = 2;
  startTime = Date.now();
  lastSpawnTime = 0;
  gameoverSound.pause();
  gameoverSound.currentTime = 0;
  if (!isMuted) {
    bgm.currentTime = 0;
    bgm.play();
  }
}

function spawnBall() {
  let keys = ["pink","orange","blue","green","yellow","lightblue"];
  let elapsed = (Date.now()-startTime)/1000;
  if (elapsed > 20) keys.push("rainbow");
  let color = keys[Math.floor(Math.random()*keys.length)];
  let size = 40 * 1.5;
  let x = Math.random()*(canvas.width-size);
  let speed = speeds[color]+2;
  if (color==="rainbow") speed += 2;
  balls.push({x:x,y:0,w:size,h:size,color:color,speed:speed});
}

function update() {
  if (gameState !== "playing") return;
  let now = Date.now();
  if (now - lastSpawnTime > spawnInterval && balls.length < maxBalls) {
    spawnBall();
    lastSpawnTime = now;
  }
  let elapsed = (now-startTime)/1000;
  if (elapsed > 0 && Math.floor(elapsed/10)+2 > maxBalls && maxBalls < 12) {
    maxBalls++;
  }
  balls.forEach((b,i)=>{
    b.y += b.speed;
    if (b.y+b.h > paddle.y && b.x < paddle.x+paddle.w/2 && b.x+b.w > paddle.x-paddle.w/2) {
      if (b.color==="rainbow") {
        score += 10;
        if (!isMuted) catchRare.play();
      } else {
        score += 1;
        if (!isMuted) catchNormal.play();
      }
      balls.splice(i,1);
    } else if (b.y > canvas.height) {
      if (b.color!=="rainbow") {
        lives--;
        if (!isMuted) missSound.play();
        if (lives<=0) endGame();
      }
      balls.splice(i,1);
    }
  });
}

function endGame() {
  gameState = "gameover";
  if (score > highScore) highScore = score;
  bgm.pause();
  bgm.currentTime = 0;
  if (!isMuted) gameoverSound.play();
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (gameState==="title") {
    ctx.drawImage(titleImage,0,0,canvas.width,canvas.height);
    ctx.fillStyle="white";
    ctx.font = "40px 'Fredoka One'";
    ctx.textAlign="center";
    if (Math.floor(Date.now()/500)%2===0) {
      ctx.fillText("TAP TO START", canvas.width/2, canvas.height*0.85);
    }
  } else {
    ctx.drawImage(bgImage,0,0,canvas.width,canvas.height);
    ctx.drawImage(paddleImage,paddle.x-paddle.w/2,paddle.y,paddle.w,paddle.h);
    balls.forEach(b=>ctx.drawImage(ballImages[b.color],b.x,b.y,b.w,b.h));
    ctx.fillStyle="white";
    ctx.font = "32px 'Fredoka One'";
    ctx.textAlign="center";
    ctx.fillText("SCORE: "+score, canvas.width/2, 40);
    ctx.fillStyle="pink";
    ctx.fillText("♥ "+lives, canvas.width/2, 80);
    if (gameState==="gameover") {
      ctx.fillStyle="red";
      ctx.font="50px 'Fredoka One'";
      ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2);
      ctx.font="30px 'Fredoka One'";
      ctx.fillStyle="white";
      ctx.fillText("HIGH SCORE: "+highScore, canvas.width/2, canvas.height/2+60);
      ctx.fillText("TAP TO RETRY", canvas.width/2, canvas.height/2+120);
    }
  }
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
