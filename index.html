<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Pickleball Catch!</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: black;
    }
  </style>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // 16:9 固定サイズ
    function resizeCanvas() {
      let w = window.innerWidth;
      let h = window.innerHeight;
      if (w / h > 16/9) {
        h = window.innerHeight;
        w = h * 16/9;
      } else {
        w = window.innerWidth;
        h = w * 9/16;
      }
      canvas.width = w;
      canvas.height = h;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // 画像
    const bgImg = new Image(); bgImg.src = "bg.png";
    const titleImg = new Image(); titleImg.src = "title.png";
    const paddleImg = new Image(); paddleImg.src = "paddle.png";
    const ballImgs = {
      pink: "pink.png",
      orange: "orange.png",
      blue: "blue.png",
      lightblue: "lightblue.png",
      green: "green.png",
      yellow: "yellow.png",
      rainbow: "rainbow.png"
    };
    for (let key in ballImgs) {
      const img = new Image();
      img.src = ballImgs[key];
      ballImgs[key] = img;
    }

    // サウンド
    const bgm = new Audio("bgm.mp3");
    bgm.loop = true;
    bgm.volume = 0.2;
    const catchSound = new Audio("catch.mp3");
    const rareSound = new Audio("rare.mp3");

    // 状態
    let gameState = "title"; // title, playing, gameover
    let score = 0;
    let highScore = 0;
    let lives = 3;
    let paddle = { x: 0, y: 0, width: 150, height: 40 };
    let balls = [];
    let lastSpawn = 0;
    let maxBalls = 2;
    let startTime = null;

    // ボール設定
    const ballTypes = {
      pink: { speed: 1, score: 10 },
      orange: { speed: 2, score: 20 },
      blue: { speed: 3, score: 30 },
      lightblue: { speed: 4, score: 40 },
      green: { speed: 5, score: 50 },
      yellow: { speed: 6, score: 60 },
      rainbow: { speed: 8, score: 200, rare: true }
    };

    // 入力
    window.addEventListener("mousemove", e => {
      if (gameState !== "playing") return;
      const rect = canvas.getBoundingClientRect();
      paddle.x = e.clientX - rect.left - paddle.width / 2;
    });
    window.addEventListener("touchmove", e => {
      if (gameState !== "playing") return;
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches[0];
      paddle.x = touch.clientX - rect.left - paddle.width / 2;
    });

    canvas.addEventListener("click", e => {
      if (gameState === "title") {
        startGame();
      } else if (gameState === "gameover") {
        // リトライボタンの範囲
        const rect = canvas.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        if (
          clickX > canvas.width / 2 - 150 &&
          clickX < canvas.width / 2 + 150 &&
          clickY > canvas.height / 2 + 100 &&
          clickY < canvas.height / 2 + 180
        ) {
          startGame();
        }
      }
    });

    function startGame() {
      gameState = "playing";
      score = 0;
      lives = 3;
      balls = [];
      maxBalls = 2;
      startTime = Date.now();
      bgm.play();
    }

    // ボール生成
    function spawnBall() {
      const keys = Object.keys(ballTypes);
      let key;
      if (Math.random() < 0.05) {
        key = "rainbow";
      } else {
        key = keys[Math.floor(Math.random() * (keys.length - 1))];
      }
      balls.push({
        x: Math.random() * (canvas.width - 80),
        y: -80,
        size: 120,
        type: key
      });
    }

    function update() {
      if (!startTime) startTime = Date.now();
      const elapsed = (Date.now() - startTime) / 1000;

      if (elapsed - lastSpawn > 1 && balls.length < maxBalls) {
        spawnBall();
        lastSpawn = elapsed;
      }
      if (Math.floor(elapsed / 10) + 2 > maxBalls && maxBalls < 12) {
        maxBalls = Math.floor(elapsed / 10) + 2;
      }

      paddle.y = canvas.height - 100;
      paddle.width = 300;
      paddle.height = 80;

      balls.forEach((b, i) => {
        b.y += ballTypes[b.type].speed + 2;
        if (
          b.y + b.size >= paddle.y &&
          b.x + b.size > paddle.x &&
          b.x < paddle.x + paddle.width
        ) {
          score += ballTypes[b.type].score;
          if (b.type === "rainbow") {
            rareSound.currentTime = 0; rareSound.play();
          } else {
            catchSound.currentTime = 0; catchSound.play();
          }
          balls.splice(i, 1);
        } else if (b.y > canvas.height) {
          if (!ballTypes[b.type].rare) {
            lives--;
            if (lives <= 0) {
              gameOver();
            }
          }
          balls.splice(i, 1);
        }
      });
    }

    function gameOver() {
      gameState = "gameover";
      bgm.pause();
      bgm.currentTime = 0;
      if (score > highScore) highScore = score;
    }

    function draw() {
      ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

      ctx.drawImage(paddleImg, paddle.x, paddle.y, paddle.width, paddle.height);
      balls.forEach(b => {
        ctx.drawImage(ballImgs[b.type], b.x, b.y, b.size, b.size);
      });

      ctx.fillStyle = "white";
      ctx.font = "48px 'Fredoka One'";
      ctx.textAlign = "center";
      ctx.fillText("Score: " + score, canvas.width / 2, 60);
      ctx.fillText("♥".repeat(lives), canvas.width / 2, 120);
    }

    function drawTitleScreen() {
      ctx.drawImage(titleImg, 0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "white";
      ctx.font = "96px 'Fredoka One'";
      ctx.textAlign = "center";
      ctx.fillText("Pickleball Catch!", canvas.width / 2, canvas.height / 2 - 60);

      const blink = Math.floor(Date.now() / 500) % 2;
      if (blink === 0) {
        ctx.fillStyle = "#ff66cc";
        ctx.font = "48px 'Fredoka One'";
        ctx.fillText("Tap to Start!", canvas.width / 2, canvas.height / 2 + 40);
      }
    }

    function drawGameOver() {
      ctx.fillStyle = "rgba(0,0,0,0.7)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "white";
      ctx.textAlign = "center";
      ctx.font = "120px 'Fredoka One'";
      ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2 - 100);

      ctx.font = "80px 'Fredoka One'";
      ctx.fillStyle = "#ffcc00";
      ctx.fillText("Score: " + score, canvas.width / 2, canvas.height / 2 + 20);
      ctx.fillStyle = "#66ff66";
      ctx.fillText("High Score: " + highScore, canvas.width / 2, canvas.height / 2 + 100);

      // リトライボタン
      ctx.fillStyle = "#ff66cc";
      ctx.fillRect(canvas.width / 2 - 150, canvas.height / 2 + 120, 300, 80);
      ctx.fillStyle = "white";
      ctx.font = "48px 'Fredoka One'";
      ctx.fillText("Retry", canvas.width / 2, canvas.height / 2 + 175);
    }

    function loop() {
      if (gameState === "title") {
        drawTitleScreen();
      } else if (gameState === "playing") {
        update();
        draw();
      } else if (gameState === "gameover") {
        drawGameOver();
      }
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
